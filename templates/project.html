<!DOCTYPE html>
<html lang="hu" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projekt: {{ project.name }} | AI Dubbing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .file-browser-tree {
            list-style: none;
            padding-left: 0;
        }
        .file-browser-tree ul {
            list-style: none;
            padding-left: 1rem;
            margin: 0.25rem 0;
        }
        .file-browser-summary {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .file-browser-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.15rem 0;
        }
        .file-browser-icon {
            width: 1.5rem;
            display: inline-flex;
            justify-content: center;
            font-weight: 600;
        }
        details.file-browser-directory > summary {
            cursor: pointer;
        }
    </style>
    <script>
        const PROJECT_NAME = "{{ project.name }}";
        let workflowPollInterval = null;
        let workflowLogInterval = null;
        let currentWorkflowJobId = null;
        let currentLogJobId = null;
        let workflowInfoDismissed = false;
        let workflowKeysModal = null;
        let workflowStepModal = null;
        let workflowParamsModal = null;
        let workflowSaveModal = null;
        let pendingWorkflowPayload = null;
        let availableScripts = [];
        let defaultWorkflow = [];
        let workflowSteps = [];
        let selectedStepIndex = null;
        let workflowTemplates = [];
        let currentTemplateId = null;
        let workflowInitialized = false;

        const workflowKeyFieldMap = {
            chatgpt: { wrapperId: 'workflowKeyFieldChatgpt', inputId: 'workflowKeyChatgpt', payloadKey: 'chatgpt_api_key' },
            deepl: { wrapperId: 'workflowKeyFieldDeepl', inputId: 'workflowKeyDeepl', payloadKey: 'deepl_api_key' },
            huggingface: { wrapperId: 'workflowKeyFieldHuggingface', inputId: 'workflowKeyHuggingface', payloadKey: 'huggingface_token' }
        };

        const workflowWidgets = [
            {
                id: 'reviewContinue',
                name: 'Review + Continue',
                description: 'Felülvizsgálati nézet megnyitása és kézi folytatás.',
                continueLabel: 'Continue',
                reviewLabel: 'Review'
            }
        ];

        function findWidgetById(widgetId) {
            if (!widgetId) {
                return null;
            }
            return workflowWidgets.find(widget => widget.id === widgetId) || null;
        }

        function normalizeWorkflowStep(step) {
            if (!step || typeof step !== 'object') {
                return;
            }
            if (!step.type) {
                if (step.widget) {
                    step.type = 'widget';
                } else if (step.script) {
                    step.type = 'script';
                }
            }
            if (step.type === 'widget') {
                if (!step.widget) {
                    step.widget = 'unknownWidget';
                }
                if (step.enabled === undefined) {
                    step.enabled = true;
                }
            } else {
                step.type = 'script';
                if (step.enabled === undefined) {
                    step.enabled = true;
                }
                if (step.halt_on_fail === undefined) {
                    step.halt_on_fail = true;
                }
                if (!step.params || typeof step.params !== 'object') {
                    step.params = {};
                }
            }
        }

        function normalizeWorkflowStepList(steps) {
            (steps || []).forEach(normalizeWorkflowStep);
            return steps || [];
        }

        function collectScriptStepsForRun(startIndex = 0) {
            const stepsForRun = [];
            for (let i = startIndex; i < workflowSteps.length; i++) {
                const step = workflowSteps[i];
                if (step.type === 'widget') {
                    if (step.enabled !== false) {
                        break;
                    }
                    continue;
                }
                if (step.enabled === false) {
                    continue;
                }
                stepsForRun.push({
                    script: step.script,
                    enabled: true,
                    halt_on_fail: step.halt_on_fail !== false,
                    params: cloneObject(step.params)
                });
            }
            return stepsForRun;
        }

        function collectWorkflowState() {
            return cloneSteps(workflowSteps);
        }

        function buildRunPayload(startIndex = 0) {
            return {
                steps: collectScriptStepsForRun(startIndex),
                template_id: currentTemplateId,
                workflow_state: collectWorkflowState()
            };
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            let newTheme = 'light';
            if (currentTheme === 'light' || (currentTheme === 'auto' && !systemDark)) {
                newTheme = 'dark';
            } else {
                newTheme = 'auto';
            }

            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function cloneSteps(steps) {
            const cloned = JSON.parse(JSON.stringify(steps || []));
            return normalizeWorkflowStepList(cloned);
        }

        function cloneObject(obj) {
            return JSON.parse(JSON.stringify(obj || {}));
        }

        function findScriptById(scriptId) {
            if (!scriptId) return null;
            return availableScripts.find(entry => entry.id === scriptId) || null;
        }

        function getMissingParams(step, script) {
            if (!script || !script.parameters) {
                return [];
            }
            return script.parameters
                .filter(param => param.required && param.type !== 'flag' && !param.autofill)
                .map(param => param.name)
                .filter(name => {
                    const value = step.params ? step.params[name] : undefined;
                    if (value === undefined || value === null) {
                        return true;
                    }
                    if (typeof value === 'string' && value.trim() === '') {
                        return true;
                    }
                    return false;
                });
        }

        function describeStepParameters(step, script, missing) {
            if (missing && missing.length) {
                return `Hiányzó kötelező paraméterek: ${missing.join(', ')}`;
            }
            const summary = [];
            if (script && script.parameters) {
                script.parameters.forEach(param => {
                    const value = step.params ? step.params[param.name] : undefined;
                    if (param.type === 'flag') {
                        if (value === true) {
                            summary.push(`${param.name}=on`);
                        } else if (value === false) {
                            summary.push(`${param.name}=off`);
                        }
                    } else if (value !== undefined && value !== null && !(typeof value === 'string' && value.trim() === '')) {
                        summary.push(`${param.name}=${value}`);
                    }
                });
            }
            Object.entries(step.params || {}).forEach(([key, value]) => {
                if (!script || !(script.parameters || []).some(param => param.name === key)) {
                    summary.push(`${key}=${value}`);
                }
            });
            return summary.length ? summary.join(', ') : 'Nincs megadott paraméter';
        }

        function updateMissingBadge() {
            const badge = document.getElementById('workflowMissingBadge');
            if (!badge) return;
            const hasMissing = workflowSteps.some(step =>
                step.type !== 'widget' &&
                step.enabled !== false &&
                getMissingParams(step, findScriptById(step.script)).length
            );
            badge.classList.toggle('d-none', !hasMissing);
        }

        function findTemplateById(templateId) {
            if (!templateId) {
                return null;
            }
            return workflowTemplates.find(item => item.id === templateId) || null;
        }

        function populateWorkflowTemplateSelect(selectedId) {
            const select = document.getElementById('workflowTemplateSelect');
            if (!select) {
                return;
            }
            const previousValue = selectedId !== undefined ? selectedId : select.value;
            select.innerHTML = '';

            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Válassz sablont...';
            select.append(placeholder);

            workflowTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name || template.id;
                select.append(option);
            });

            const targetValue = selectedId !== undefined ? selectedId : previousValue;
            if (targetValue && Array.from(select.options).some(option => option.value === targetValue)) {
                select.value = targetValue;
                currentTemplateId = targetValue;
            } else {
                select.value = '';
                if (selectedId !== undefined) {
                    currentTemplateId = null;
                }
            }
        }

        async function refreshWorkflowTemplates(selectedId = currentTemplateId) {
            try {
                const response = await fetch('/api/workflow-templates');
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Nem sikerült lekérdezni a sablonokat.');
                }
                workflowTemplates = result.templates || [];
                populateWorkflowTemplateSelect(selectedId);
            } catch (error) {
                console.error('Workflow sablon lista frissítési hiba:', error);
            }
        }

        async function loadWorkflowTemplateById(templateId, showMessage = true) {
            if (!templateId) {
                alert('Előbb válassz egy workflow sablont.');
                return;
            }
            try {
                const response = await fetch(`/api/workflow-template/${encodeURIComponent(templateId)}`);
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Nem sikerült betölteni a sablont.');
                }
                const template = result.template || {};
                currentTemplateId = template.id || templateId;
                workflowSteps = cloneSteps(template.steps || []);
                defaultWorkflow = cloneSteps(template.steps || []);
                populateWorkflowTemplateSelect(currentTemplateId);
                renderWorkflowSteps();
                if (showMessage) {
                    updateInfoBox('info', `${template.name || currentTemplateId} sablon betöltve.`);
                }
            } catch (error) {
                console.error('Workflow sablon betöltési hiba:', error);
                alert('Nem sikerült betölteni a kiválasztott workflow-t: ' + error.message);
            }
        }

        function showSaveWorkflowModal() {
            const modalElement = document.getElementById('workflowSaveModal');
            if (!modalElement) {
                return;
            }
            const nameInput = document.getElementById('workflowSaveName');
            const descriptionInput = document.getElementById('workflowSaveDescription');
            const overwriteCheckbox = document.getElementById('workflowSaveOverwrite');
            const overwriteInfo = document.getElementById('workflowSaveOverwriteInfo');
            const errorBox = document.getElementById('workflowSaveError');

            const currentTemplate = findTemplateById(currentTemplateId);
            if (nameInput) {
                nameInput.value = currentTemplate ? (currentTemplate.name || '') : '';
            }
            if (descriptionInput) {
                descriptionInput.value = currentTemplate ? (currentTemplate.description || '') : '';
            }
            if (overwriteCheckbox) {
                overwriteCheckbox.checked = false;
                overwriteCheckbox.disabled = !currentTemplateId;
            }
            if (overwriteInfo) {
                if (currentTemplate) {
                    overwriteInfo.textContent = `Aktuális sablon: ${currentTemplate.name} (${currentTemplate.id})`;
                    overwriteInfo.classList.remove('d-none');
                } else {
                    overwriteInfo.classList.add('d-none');
                }
            }
            if (errorBox) {
                errorBox.classList.add('d-none');
                errorBox.textContent = '';
            }
            if (!workflowSaveModal) {
                workflowSaveModal = new bootstrap.Modal(modalElement);
            }
            workflowSaveModal.show();
        }

        async function saveWorkflowTemplateFromModal() {
            const nameInput = document.getElementById('workflowSaveName');
            const descriptionInput = document.getElementById('workflowSaveDescription');
            const overwriteCheckbox = document.getElementById('workflowSaveOverwrite');
            const errorBox = document.getElementById('workflowSaveError');

            const name = nameInput ? nameInput.value.trim() : '';
            const description = descriptionInput ? descriptionInput.value.trim() : '';
            const overwrite = overwriteCheckbox ? overwriteCheckbox.checked : false;

            if (errorBox) {
                errorBox.classList.add('d-none');
                errorBox.textContent = '';
            }

            if (overwrite && !currentTemplateId) {
                if (errorBox) {
                    errorBox.textContent = 'Nincs kiválasztott sablon, amit felül lehetne írni.';
                    errorBox.classList.remove('d-none');
                }
                return;
            }

            if (!name && !overwrite) {
                if (errorBox) {
                    errorBox.textContent = 'Adj meg egy nevet a workflow sablonnak.';
                    errorBox.classList.remove('d-none');
                }
                return;
            }

            const workflowState = collectWorkflowState();
            const body = {
                name,
                description,
                steps: workflowState,
                overwrite
            };
            if (overwrite && currentTemplateId) {
                body.template_id = currentTemplateId;
            }

            try {
                const response = await fetch('/api/save-workflow-template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Nem sikerült elmenteni a workflow sablont.');
                }
                if (workflowSaveModal) {
                    workflowSaveModal.hide();
                }
                const savedTemplate = result.template || {};
                currentTemplateId = savedTemplate.id || currentTemplateId;
                defaultWorkflow = cloneSteps(workflowState);
                await refreshWorkflowTemplates(currentTemplateId);
                populateWorkflowTemplateSelect(currentTemplateId);
                updateInfoBox('success', `Workflow sablon elmentve: ${savedTemplate.name || currentTemplateId}.`);
            } catch (error) {
                console.error('Workflow sablon mentési hiba:', error);
                if (errorBox) {
                    errorBox.textContent = error.message;
                    errorBox.classList.remove('d-none');
                }
            }
        }

        function initWorkflowButtons() {
            const templateSelect = document.getElementById('workflowTemplateSelect');
            if (templateSelect) {
                templateSelect.addEventListener('change', event => {
                    const value = event.target.value || '';
                    currentTemplateId = value || null;
                });
            }

            const loadTemplateBtn = document.getElementById('loadWorkflowTemplateBtn');
            if (loadTemplateBtn) {
                loadTemplateBtn.addEventListener('click', () => {
                    if (!currentTemplateId) {
                        alert('Előbb válassz egy workflow sablont a listából.');
                        return;
                    }
                    loadWorkflowTemplateById(currentTemplateId);
                });
            }

            const saveTemplateBtn = document.getElementById('saveWorkflowBtn');
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', showSaveWorkflowModal);
            }

            const addBtn = document.getElementById('addWorkflowStepBtn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    if (!availableScripts.length) {
                        alert('A scripts lista még nem töltődött be. Próbáld újra néhány másodperc múlva.');
                        return;
                    }
                    openWorkflowStepPicker();
                });
            }

            const resetBtn = document.getElementById('resetWorkflowBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (!defaultWorkflow.length) {
                        alert('Nincs elérhető alapértelmezett workflow.');
                        return;
                    }
                    if (!confirm('Biztosan visszaállítod az alapértelmezett lépéssort?')) {
                        return;
                    }
                    workflowSteps = cloneSteps(defaultWorkflow);
                    renderWorkflowSteps();
                    updateInfoBox('info', 'Az alapértelmezett lépéssor betöltve.');
                });
            }

            const startBtn = document.getElementById('startWorkflowBtn');
            if (startBtn) {
                startBtn.addEventListener('click', handleStartWorkflow);
            }

            const stopBtn = document.getElementById('stopWorkflowBtn');
            if (stopBtn) {
                stopBtn.addEventListener('click', stopWorkflow);
            }

            const searchInput = document.getElementById('workflowStepSearch');
            if (searchInput) {
                searchInput.addEventListener('input', event => populateWorkflowStepList(event.target.value || ''));
            }

            const widgetMenu = document.getElementById('workflowWidgetMenu');
            if (widgetMenu) {
                widgetMenu.querySelectorAll('[data-widget-id]').forEach(item => {
                    item.addEventListener('click', event => {
                        const widgetId = event.currentTarget.getAttribute('data-widget-id');
                        if (widgetId) {
                            addWorkflowWidget(widgetId);
                        }
                    });
                });
            }
        }

        function initWorkflowModals() {
            const stepModalElement = document.getElementById('workflowStepModal');
            if (stepModalElement) {
                workflowStepModal = new bootstrap.Modal(stepModalElement);
                stepModalElement.addEventListener('shown.bs.modal', () => {
                    const searchInput = document.getElementById('workflowStepSearch');
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.focus();
                        populateWorkflowStepList('');
                    }
                });
            }

            const paramsModalElement = document.getElementById('workflowParamsModal');
            if (paramsModalElement) {
                workflowParamsModal = new bootstrap.Modal(paramsModalElement);
                paramsModalElement.addEventListener('hidden.bs.modal', () => {
                    selectedStepIndex = null;
                    const alertBox = document.getElementById('workflowParamsAlert');
                    if (alertBox) {
                        alertBox.classList.add('d-none');
                        alertBox.textContent = '';
                    }
                });
                const saveBtn = document.getElementById('workflowParamsSaveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveWorkflowParams);
                }
            }

            const saveModalElement = document.getElementById('workflowSaveModal');
            if (saveModalElement) {
                workflowSaveModal = new bootstrap.Modal(saveModalElement);
                const saveConfirmBtn = document.getElementById('workflowSaveConfirmBtn');
                if (saveConfirmBtn) {
                    saveConfirmBtn.addEventListener('click', saveWorkflowTemplateFromModal);
                }
            }
        }

        function initWorkflowKeyModal() {
            const modalElement = document.getElementById('workflowKeysModal');
            if (modalElement) {
                workflowKeysModal = new bootstrap.Modal(modalElement);
                modalElement.addEventListener('hidden.bs.modal', () => {
                    resetWorkflowKeyModal();
                    pendingWorkflowPayload = null;
                });
                const submitBtn = document.getElementById('workflowKeysSubmitBtn');
                if (submitBtn) {
                    submitBtn.addEventListener('click', saveWorkflowKeys);
                }
            }
        }

        async function loadWorkflowOptions(projectName) {
            const statusText = document.getElementById('workflowStatusText');
            const startButton = document.getElementById('startWorkflowBtn');
            try {
                const response = await fetch(`/api/workflow-options/${encodeURIComponent(projectName)}`);
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Ismeretlen hiba');
                }

                availableScripts = result.scripts || [];
                workflowTemplates = result.templates || [];
                const defaults = result.defaults || {};

                defaultWorkflow = cloneSteps(defaults.workflow || []);

                if (!workflowInitialized) {
                    workflowSteps = cloneSteps(defaultWorkflow);
                    workflowInitialized = true;
                } else if (!workflowSteps.length && defaultWorkflow.length) {
                    workflowSteps = cloneSteps(defaultWorkflow);
                }

                currentTemplateId = defaults.selected_template || currentTemplateId || (workflowTemplates.length ? workflowTemplates[0].id : null);
                populateWorkflowTemplateSelect(currentTemplateId);

                renderWorkflowSteps();
                renderWorkflowStatus(result.latest_job);

                if (result.latest_job && ['queued', 'running', 'cancelling'].includes(result.latest_job.status)) {
                    currentWorkflowJobId = result.latest_job.job_id;
                    startWorkflowPolling(result.latest_job.job_id, true);
                }

                const hasScriptSteps = workflowSteps.some(step => step.type !== 'widget');
                const hasEnabledScripts = workflowSteps.some(step => step.type !== 'widget' && step.enabled !== false);
                const runnableSegment = collectScriptStepsForRun(0);
                if (statusText) {
                    if (!hasScriptSteps) {
                        statusText.textContent = 'Adj hozzá futtatható lépéseket az indításhoz.';
                    } else if (!hasEnabledScripts) {
                        statusText.textContent = 'Engedélyezz legalább egy lépést az indításhoz.';
                    } else if (!runnableSegment.length) {
                        statusText.textContent = 'Az első widget előtt nincs futtatható lépés. Használd a Continue gombot.';
                    } else {
                        statusText.textContent = 'Workflow készen áll az indításra.';
                    }
                }

                if (startButton) {
                    startButton.disabled = !runnableSegment.length;
                }
            } catch (error) {
                console.error('Hiba a workflow opciók betöltésekor:', error);
                if (statusText) {
                    statusText.textContent = `Hiba: ${error.message}`;
                }
                if (startButton) {
                    startButton.disabled = true;
                }
                updateInfoBox('danger', `Nem sikerült betölteni a workflow opciókat: ${error.message}`);
            }
        }

        function renderWorkflowSteps() {
            const tbody = document.getElementById('workflowStepsBody');
            if (!tbody) {
                return;
            }
            tbody.innerHTML = '';
            if (!workflowSteps.length) {
                const row = document.createElement('tr');
                row.className = 'text-muted';
                const cell = document.createElement('td');
                cell.colSpan = 5;
                cell.textContent = 'Még nem adtál hozzá lépéseket.';
                row.append(cell);
                tbody.append(row);
                updateMissingBadge();
                const startButtonEmpty = document.getElementById('startWorkflowBtn');
                if (startButtonEmpty) {
                    startButtonEmpty.disabled = true;
                }
                return;
            }

            workflowSteps.forEach((step, index) => {
                normalizeWorkflowStep(step);
                const isWidget = step.type === 'widget';
                const script = !isWidget ? findScriptById(step.script) : null;
                const row = document.createElement('tr');
                if (isWidget) {
                    row.classList.add('table-info');
                }
                if (step.enabled === false) {
                    row.classList.add('table-light', 'text-muted');
                }
                const missing = (!isWidget && step.enabled !== false) ? getMissingParams(step, script) : [];
                if (missing.length) {
                    row.classList.add('table-warning');
                }

                const enabledCell = document.createElement('td');
                const enabledWrapper = document.createElement('div');
                enabledWrapper.className = 'form-check form-switch';
                const enabledCheckbox = document.createElement('input');
                enabledCheckbox.type = 'checkbox';
                enabledCheckbox.className = 'form-check-input';
                enabledCheckbox.checked = step.enabled !== false;
                enabledCheckbox.addEventListener('change', () => {
                    step.enabled = enabledCheckbox.checked;
                    renderWorkflowSteps();
                });
                enabledWrapper.append(enabledCheckbox);
                enabledCell.append(enabledWrapper);
                row.append(enabledCell);

                const infoCell = document.createElement('td');
                if (isWidget) {
                    const widget = findWidgetById(step.widget);
                    const title = document.createElement('div');
                    title.className = 'fw-semibold';
                    title.textContent = widget ? widget.name : 'Speciális widget';
                    infoCell.append(title);

                    if (widget && widget.description) {
                        const desc = document.createElement('div');
                        desc.className = 'small text-muted';
                        desc.textContent = widget.description;
                        infoCell.append(desc);
                    }

                    const buttonRow = document.createElement('div');
                    buttonRow.className = 'd-flex flex-wrap gap-2 mt-2';

                    const reviewBtn = document.createElement('button');
                    reviewBtn.type = 'button';
                    reviewBtn.className = 'btn btn-sm btn-outline-info';
                    reviewBtn.textContent = widget && widget.reviewLabel ? widget.reviewLabel : 'Review';
                    reviewBtn.disabled = step.enabled === false;
                    reviewBtn.addEventListener('click', () => {
                        const url = `/review/${encodeURIComponent(PROJECT_NAME)}`;
                        window.open(url, '_blank', 'noopener');
                    });

                    const continueBtn = document.createElement('button');
                    continueBtn.type = 'button';
                    continueBtn.className = 'btn btn-sm btn-success';
                    continueBtn.textContent = widget && widget.continueLabel ? widget.continueLabel : 'Continue';
                    const hasRemainingScripts = collectScriptStepsForRun(index + 1).length > 0;
                    continueBtn.disabled = step.enabled === false || !hasRemainingScripts;
                    if (!hasRemainingScripts) {
                        continueBtn.title = 'Nincs további futtatható lépés.';
                    }
                    continueBtn.addEventListener('click', () => handleWidgetContinue(index));

                    buttonRow.append(reviewBtn, continueBtn);
                    infoCell.append(buttonRow);
                } else {
                    const title = document.createElement('div');
                    title.className = 'fw-semibold';
                    title.textContent = (script && script.display_name) || step.script;
                    infoCell.append(title);

                    if (script) {
                        const scriptPath = document.createElement('div');
                        scriptPath.className = 'small text-muted';
                        scriptPath.textContent = script.script;
                        infoCell.append(scriptPath);
                    }

                    const summary = document.createElement('div');
                    summary.className = 'small mt-1';
                    summary.textContent = describeStepParameters(step, script, missing);
                    infoCell.append(summary);

                    if (script && script.required_keys && script.required_keys.length) {
                        const keyLine = document.createElement('div');
                        keyLine.className = 'small mt-1';
                        script.required_keys.forEach(key => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1';
                            badge.textContent = key;
                            keyLine.append(badge);
                        });
                        infoCell.append(keyLine);
                    }
                }
                row.append(infoCell);

                const envCell = document.createElement('td');
                if (isWidget) {
                    const widgetBadge = document.createElement('span');
                    widgetBadge.className = 'badge bg-light text-dark border';
                    widgetBadge.textContent = 'Widget';
                    envCell.append(widgetBadge);
                } else if (script && script.environment) {
                    const envBadge = document.createElement('span');
                    envBadge.className = 'badge bg-light text-dark border';
                    envBadge.textContent = script.environment;
                    envCell.append(envBadge);
                } else {
                    envCell.innerHTML = '&mdash;';
                }
                row.append(envCell);

                const haltCell = document.createElement('td');
                if (isWidget) {
                    haltCell.innerHTML = '&mdash;';
                } else {
                    const haltWrapper = document.createElement('div');
                    haltWrapper.className = 'form-check form-switch';
                    const haltCheckbox = document.createElement('input');
                    haltCheckbox.type = 'checkbox';
                    haltCheckbox.className = 'form-check-input';
                    haltCheckbox.checked = step.halt_on_fail !== false;
                    haltCheckbox.addEventListener('change', () => {
                        step.halt_on_fail = haltCheckbox.checked;
                        renderWorkflowSteps();
                    });
                    const haltLabel = document.createElement('label');
                    haltLabel.className = 'form-check-label small';
                    haltLabel.textContent = haltCheckbox.checked ? 'Megáll hibánál' : 'Tovább hiba után';
                    haltWrapper.append(haltCheckbox, haltLabel);
                    haltCell.append(haltWrapper);
                }
                row.append(haltCell);

                const actionsCell = document.createElement('td');
                actionsCell.className = 'text-end';
                if (!isWidget) {
                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'btn btn-sm btn-outline-primary me-2';
                    editBtn.textContent = 'Paraméterek';
                    editBtn.addEventListener('click', () => openWorkflowParams(index));
                    actionsCell.append(editBtn);
                }

                const upBtn = document.createElement('button');
                upBtn.type = 'button';
                upBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                upBtn.innerHTML = '&uarr;';
                upBtn.disabled = index === 0;
                upBtn.addEventListener('click', () => moveWorkflowStep(index, -1));

                const downBtn = document.createElement('button');
                downBtn.type = 'button';
                downBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                downBtn.innerHTML = '&darr;';
                downBtn.disabled = index === workflowSteps.length - 1;
                downBtn.addEventListener('click', () => moveWorkflowStep(index, 1));

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', () => removeWorkflowStep(index));

                actionsCell.append(upBtn, downBtn, removeBtn);
                row.append(actionsCell);

                tbody.append(row);
            });

            updateMissingBadge();

            const startButton = document.getElementById('startWorkflowBtn');
            if (startButton) {
                const runnableSegment = collectScriptStepsForRun(0);
                startButton.disabled = runnableSegment.length === 0;
            }

            const statusText = document.getElementById('workflowStatusText');
            if (statusText && !currentWorkflowJobId) {
                const hasAnyScript = workflowSteps.some(step => step.type !== 'widget');
                const hasEnabledScripts = workflowSteps.some(step => step.type !== 'widget' && step.enabled !== false);
                const runnableSegment = collectScriptStepsForRun(0);
                if (!hasAnyScript) {
                    statusText.textContent = 'Adj hozzá futtatható lépéseket az indításhoz.';
                } else if (!hasEnabledScripts) {
                    statusText.textContent = 'Engedélyezz legalább egy lépést az indításhoz.';
                } else if (!runnableSegment.length) {
                    statusText.textContent = 'Az első widget előtt nincs futtatható lépés. Használd a Continue gombot.';
                } else {
                    statusText.textContent = 'Workflow készen áll az indításra.';
                }
            }
        }

        function openWorkflowStepPicker() {
            populateWorkflowStepList('');
            if (workflowStepModal) {
                workflowStepModal.show();
            }
        }

        function populateWorkflowStepList(filterText) {
            const list = document.getElementById('workflowStepList');
            if (!list) {
                return;
            }
            list.innerHTML = '';
            const term = (filterText || '').toLowerCase();
            const scripts = availableScripts
                .slice()
                .sort((a, b) => (a.display_name || a.script).localeCompare(b.display_name || b.script));
            const filtered = term
                ? scripts.filter(script =>
                    (script.display_name && script.display_name.toLowerCase().includes(term)) ||
                    (script.script && script.script.toLowerCase().includes(term)))
                : scripts;

            if (!filtered.length) {
                const empty = document.createElement('div');
                empty.className = 'list-group-item text-muted';
                empty.textContent = 'Nincs a keresésnek megfelelő szkript.';
                list.append(empty);
                return;
            }

            filtered.forEach(script => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                const header = document.createElement('div');
                header.className = 'd-flex justify-content-between align-items-start gap-3';

                const titleWrap = document.createElement('div');
                const title = document.createElement('div');
                title.className = 'fw-semibold';
                title.textContent = script.display_name || script.script;
                const subtitle = document.createElement('div');
                subtitle.className = 'small text-muted';
                subtitle.textContent = script.script;
                titleWrap.append(title, subtitle);

                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'btn btn-sm btn-primary';
                addBtn.textContent = 'Hozzáadás';
                addBtn.addEventListener('click', () => {
                    addWorkflowStep(script.id);
                    if (workflowStepModal) {
                        workflowStepModal.hide();
                    }
                });

                header.append(titleWrap, addBtn);
                item.append(header);

                if (script.environment) {
                    const envInfo = document.createElement('div');
                    envInfo.className = 'small mt-1';
                    envInfo.innerHTML = `<strong>Környezet:</strong> ${script.environment}`;
                    item.append(envInfo);
                }

                const requiredParams = (script.parameters || []).filter(param => param.required && !param.autofill);
                if (requiredParams.length) {
                    const reqInfo = document.createElement('div');
                    reqInfo.className = 'small mt-1';
                    reqInfo.innerHTML = `<strong>Kötelező paraméterek:</strong> ${requiredParams.map(param => param.name).join(', ')}`;
                    item.append(reqInfo);
                }

                if (script.required_keys && script.required_keys.length) {
                    const keyInfo = document.createElement('div');
                    keyInfo.className = 'small mt-1';
                    keyInfo.innerHTML = `<strong>Szükséges kulcsok:</strong> ${script.required_keys.join(', ')}`;
                    item.append(keyInfo);
                }

                if (script.notes) {
                    const notes = document.createElement('div');
                    notes.className = 'small mt-2 text-muted';
                    notes.textContent = script.notes;
                    item.append(notes);
                }

                list.append(item);
            });
        }

        function addWorkflowStep(scriptId) {
            const script = findScriptById(scriptId);
            if (!script) {
                alert(`Ismeretlen szkript: ${scriptId}`);
                return;
            }
            const template = (defaultWorkflow || []).find(step => step.script === script.id);
            const newStep = {
                script: script.id,
                enabled: true,
                halt_on_fail: template ? (template.halt_on_fail !== undefined ? template.halt_on_fail : true) : true,
                params: template ? cloneObject(template.params) : {}
            };
            workflowSteps.push(newStep);
            renderWorkflowSteps();
            updateInfoBox('secondary', `${script.display_name || script.script} hozzáadva a workflow-hoz.`);
        }

        function addWorkflowWidget(widgetId) {
            const widget = findWidgetById(widgetId);
            if (!widget) {
                alert(`Ismeretlen widget: ${widgetId}`);
                return;
            }
            const newStep = {
                type: 'widget',
                widget: widget.id,
                enabled: true
            };
            workflowSteps.push(newStep);
            renderWorkflowSteps();
            updateInfoBox('secondary', `${widget.name} widget hozzáadva a workflow-hoz.`);
        }

        async function handleWidgetContinue(widgetIndex) {
            if (currentWorkflowJobId) {
                updateInfoBox('warning', 'Már fut egy workflow. Várj a befejezésig.');
                return;
            }
            const widgetStep = workflowSteps[widgetIndex];
            if (!widgetStep || widgetStep.type !== 'widget') {
                return;
            }
            if (widgetStep.enabled === false) {
                updateInfoBox('info', 'Ez a widget le van tiltva.');
                return;
            }
            const validation = validateWorkflowSegment(widgetIndex + 1);
            if (!validation.hasRunnableStep) {
                updateInfoBox('info', 'Nincs további futtatható lépés.');
                return;
            }
            if (!validation.valid) {
                const messages = [...validation.errors];
                validation.missingSummary.forEach(item => {
                    messages.push(`${item.script.display_name || item.script.script}: hiányzó paraméterek – ${item.missing.join(', ')}`);
                });
                updateInfoBox('warning', messages.join(' | '));
                updateMissingBadge();
                return;
            }

            const payload = buildRunPayload(widgetIndex + 1);
            if (!payload.steps.length) {
                updateInfoBox('info', 'Nincs további futtatható lépés.');
                return;
            }

            try {
                const ready = await ensureWorkflowKeys(payload);
                if (!ready) {
                    return;
                }
                await executeWorkflow(payload);
            } catch (error) {
                console.error('Widget folytatási hiba:', error);
                alert('Nem sikerült folytatni a workflow-t: ' + error.message);
            }
        }

        function moveWorkflowStep(index, delta) {
            const newIndex = index + delta;
            if (newIndex < 0 || newIndex >= workflowSteps.length) {
                return;
            }
            const [step] = workflowSteps.splice(index, 1);
            workflowSteps.splice(newIndex, 0, step);
            renderWorkflowSteps();
        }

        function removeWorkflowStep(index) {
            const [removed] = workflowSteps.splice(index, 1);
            renderWorkflowSteps();
            if (removed) {
                let label = removed.script;
                if (removed.type === 'widget') {
                    const widget = findWidgetById(removed.widget);
                    label = widget ? widget.name : 'Widget';
                }
                updateInfoBox('secondary', `${label} eltávolítva a workflow-ból.`);
            }
        }

        function openWorkflowParams(index) {
            const step = workflowSteps[index];
            if (!step) {
                return;
            }
            const script = findScriptById(step.script);
            if (!script) {
                alert(`Ismeretlen szkript: ${step.script}`);
                return;
            }
            selectedStepIndex = index;
            const titleEl = document.getElementById('workflowParamsTitle');
            if (titleEl) {
                titleEl.textContent = `${script.display_name || script.script} – paraméterek`;
            }
            renderWorkflowParamsForm(script, step);
            if (workflowParamsModal) {
                workflowParamsModal.show();
            }
        }

        function renderWorkflowParamsForm(script, step) {
            const container = document.getElementById('workflowParamsContainer');
            const alertBox = document.getElementById('workflowParamsAlert');
            if (alertBox) {
                alertBox.classList.add('d-none');
                alertBox.textContent = '';
            }
            if (!container) {
                return;
            }
            container.innerHTML = '';
            const params = script.parameters || [];
            if (!params.length) {
                const placeholder = document.createElement('div');
                placeholder.className = 'text-muted';
                placeholder.textContent = 'Ehhez a lépéshez nem szükséges beállítás.';
                container.append(placeholder);
                return;
            }
            params.forEach(param => {
                const group = document.createElement('div');
                if (param.autofill) {
                    group.className = 'border rounded p-2 bg-body-tertiary';
                    const label = document.createElement('div');
                    label.className = 'fw-semibold';
                    label.textContent = param.name;
                    const help = document.createElement('div');
                    help.className = 'small text-muted';
                    help.textContent = param.autofill === 'project_name'
                        ? 'Automatikus érték: projektnév'
                        : 'Automatikus érték: projekt könyvtár teljes elérési útja';
                    group.append(label, help);
                    container.append(group);
                    return;
                }

                if (param.type === 'flag') {
                    group.className = 'form-check form-switch';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-check-input';
                    input.id = `workflow-param-${param.name}`;
                    input.dataset.param = param.name;
                    input.dataset.type = param.type;
                    input.checked = Boolean(step.params && step.params[param.name]);
                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.setAttribute('for', input.id);
                    label.textContent = param.name;
                    group.append(input, label);
                } else {
                    group.className = 'form-group';
                    const label = document.createElement('label');
                    label.className = 'form-label fw-semibold';
                    label.setAttribute('for', `workflow-param-${param.name}`);
                    label.textContent = param.name + (param.required ? ' *' : '');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = `workflow-param-${param.name}`;
                    input.dataset.param = param.name;
                    input.dataset.type = param.type;
                    const value = step.params ? step.params[param.name] : '';
                    input.value = value !== undefined && value !== null ? value : '';
                    group.append(label, input);
                }

                if (param.flags && param.flags.length) {
                    const flagInfo = document.createElement('div');
                    flagInfo.className = 'form-text';
                    flagInfo.textContent = `Kapcsolók: ${param.flags.join(', ')}`;
                    group.append(flagInfo);
                }

                container.append(group);
            });
        }

        function saveWorkflowParams() {
            if (selectedStepIndex === null) {
                return;
            }
            const step = workflowSteps[selectedStepIndex];
            const script = findScriptById(step.script);
            if (!script) {
                return;
            }
            const container = document.getElementById('workflowParamsContainer');
            const alertBox = document.getElementById('workflowParamsAlert');
            if (!container) {
                return;
            }
            const inputs = container.querySelectorAll('[data-param]');
            const newParams = cloneObject(step.params);
            inputs.forEach(input => {
                const name = input.dataset.param;
                const type = input.dataset.type;
                if (type === 'flag') {
                    newParams[name] = input.checked;
                } else {
                    const value = input.value.trim();
                    if (value === '') {
                        delete newParams[name];
                    } else {
                        newParams[name] = value;
                    }
                }
            });

            const missing = getMissingParams({ ...step, params: newParams }, script);
            if (missing.length && alertBox) {
                alertBox.textContent = `Hiányzó kötelező mezők: ${missing.join(', ')}`;
                alertBox.classList.remove('d-none');
                return;
            }

            step.params = newParams;
            if (workflowParamsModal) {
                workflowParamsModal.hide();
            }
            renderWorkflowSteps();
        }

        function validateWorkflowSegment(startIndex = 0) {
            const errors = [];
            const missingSummary = [];
            let hasRunnableStep = false;
            for (let i = startIndex; i < workflowSteps.length; i++) {
                const step = workflowSteps[i];
                if (step.type === 'widget') {
                    if (step.enabled !== false) {
                        break;
                    }
                    continue;
                }
                if (step.enabled === false) {
                    continue;
                }
                hasRunnableStep = true;
                const script = findScriptById(step.script);
                if (!script) {
                    errors.push(`Ismeretlen szkript: ${step.script}`);
                    continue;
                }
                const missing = getMissingParams(step, script);
                if (missing.length) {
                    missingSummary.push({ script, missing });
                }
            }
            return {
                valid: hasRunnableStep && errors.length === 0 && missingSummary.length === 0,
                hasRunnableStep,
                errors,
                missingSummary
            };
        }

        async function handleStartWorkflow() {
            const validation = validateWorkflowSegment(0);
            if (!validation.hasRunnableStep) {
                updateInfoBox('info', 'Nincs futtatható lépés az első widget előtt. Használd a Continue gombot a folytatáshoz.');
                return;
            }
            if (!validation.valid) {
                const messages = [...validation.errors];
                if (validation.missingSummary.length) {
                    validation.missingSummary.forEach(item => {
                        const script = item.script;
                        messages.push(`${script.display_name || script.script}: hiányzó paraméterek – ${item.missing.join(', ')}`);
                    });
                }
                updateInfoBox('warning', messages.join(' | '));
                updateMissingBadge();
                return;
            }

            const payload = buildRunPayload(0);
            if (!payload.steps.length) {
                updateInfoBox('info', 'Nincs futtatható lépés az első widget előtt. Használd a Continue gombot a folytatáshoz.');
                return;
            }
            try {
                const ready = await ensureWorkflowKeys(payload);
                if (!ready) {
                    return;
                }
                await executeWorkflow(payload);
            } catch (error) {
                console.error('Workflow indítási hiba:', error);
                alert('Workflow indítása sikertelen: ' + error.message);
            }
        }

        async function ensureWorkflowKeys(payload) {
            const response = await fetch(`/api/workflow-key-status/${encodeURIComponent(PROJECT_NAME)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steps: payload.steps })
            });
            const result = await response.json();
            if (!response.ok || !result.success) {
                throw new Error(result.error || 'Nem sikerült ellenőrizni az API kulcsokat.');
            }
            const missing = Object.entries(result.keys || {}).filter(([, info]) => info.required && !info.present);
            if (!missing.length) {
                pendingWorkflowPayload = null;
                return true;
            }
            const missingList = missing.map(([key, info]) => ({ key, label: info.label || key }));
            prepareWorkflowKeyModal(missingList);
            pendingWorkflowPayload = payload;
            if (workflowKeysModal) {
                workflowKeysModal.show();
            } else {
                alert('Hiányzó API kulcsok: ' + missingList.map(item => item.label).join(', '));
            }
            return false;
        }

        function prepareWorkflowKeyModal(missingList) {
            Object.entries(workflowKeyFieldMap).forEach(([key, cfg]) => {
                const wrapper = document.getElementById(cfg.wrapperId);
                const input = document.getElementById(cfg.inputId);
                if (wrapper) {
                    const isRequired = missingList.some(item => item.key === key);
                    wrapper.classList.toggle('d-none', !isRequired);
                }
                if (input) {
                    input.value = '';
                }
            });
            const info = document.getElementById('workflowKeysInfo');
            if (info) {
                const labels = missingList.map(item => item.label);
                info.textContent = 'A workflow indításához add meg a következő kulcsokat: ' + labels.join(', ');
            }
        }

        function resetWorkflowKeyModal() {
            Object.values(workflowKeyFieldMap).forEach(cfg => {
                const wrapper = document.getElementById(cfg.wrapperId);
                if (wrapper) {
                    wrapper.classList.add('d-none');
                }
                const input = document.getElementById(cfg.inputId);
                if (input) {
                    input.value = '';
                }
            });
            const info = document.getElementById('workflowKeysInfo');
            if (info) {
                info.textContent = 'A workflow indításához add meg a hiányzó API kulcsokat.';
            }
        }

        async function saveWorkflowKeys() {
            if (!pendingWorkflowPayload) {
                if (workflowKeysModal) {
                    workflowKeysModal.hide();
                }
                return;
            }
            const submitBtn = document.getElementById('workflowKeysSubmitBtn');
            const spinner = document.getElementById('workflowKeysSpinner');
            const payload = {};
            let firstEmpty = null;

            Object.values(workflowKeyFieldMap).forEach(cfg => {
                const wrapper = document.getElementById(cfg.wrapperId);
                if (wrapper && !wrapper.classList.contains('d-none')) {
                    const input = document.getElementById(cfg.inputId);
                    const value = (input ? input.value : '').trim();
                    if (!value) {
                        if (!firstEmpty && input) {
                            firstEmpty = input;
                        }
                    } else {
                        payload[cfg.payloadKey] = value;
                    }
                }
            });

            if (firstEmpty) {
                firstEmpty.focus();
                alert('Kérjük add meg az összes hiányzó kulcsot.');
                return;
            }
            if (!Object.keys(payload).length) {
                if (workflowKeysModal) {
                    workflowKeysModal.hide();
                }
                return;
            }

            if (submitBtn) {
                submitBtn.disabled = true;
            }
            if (spinner) {
                spinner.classList.remove('d-none');
            }

            try {
                const response = await fetch('/save-workflow-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Nem sikerült menteni az API kulcsokat.');
                }
                const payloadToRun = pendingWorkflowPayload;
                pendingWorkflowPayload = null;
                if (workflowKeysModal) {
                    workflowKeysModal.hide();
                }
                await executeWorkflow(payloadToRun);
            } catch (error) {
                alert('API kulcs mentése sikertelen: ' + error.message);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
                if (spinner) {
                    spinner.classList.add('d-none');
                }
            }
        }

        async function executeWorkflow(payload) {
            const statusText = document.getElementById('workflowStatusText');
            const startButton = document.getElementById('startWorkflowBtn');
            const spinner = document.getElementById('workflowSpinner');
            const stopButton = document.getElementById('stopWorkflowBtn');
            const stopSpinner = document.getElementById('stopWorkflowSpinner');
            const stopLabel = document.getElementById('stopWorkflowLabel');
            const logContent = document.getElementById('workflowLogContent');
            const logLink = document.getElementById('workflowLogLink');

            currentWorkflowJobId = null;
            stopLogPolling(true);

            if (startButton) {
                startButton.disabled = true;
                startButton.classList.add('btn-processing');
            }
            if (spinner) {
                spinner.classList.remove('d-none');
            }
            if (statusText) {
                statusText.textContent = 'Workflow indítása...';
            }
            updateInfoBox('secondary', 'Workflow indítása folyamatban. Az első lépés néhány másodpercig eltarthat.');

            if (stopButton) {
                stopButton.classList.remove('d-none');
                stopButton.disabled = true;
            }
            if (stopSpinner) {
                stopSpinner.classList.add('d-none');
            }
            if (stopLabel) {
                stopLabel.textContent = 'Workflow megszakítása';
            }
            if (logLink) {
                logLink.innerHTML = '';
            }
            if (logContent) {
                logContent.textContent = 'Log inicializálása...';
            }
            updateLogStatus('Workflow indítása... várakozás a logra.', 'muted');

            try {
                const response = await fetch(`/api/run-workflow/${encodeURIComponent(PROJECT_NAME)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Ismeretlen hiba a workflow indításakor.');
                }
                if (statusText) {
                    statusText.textContent = 'Workflow elindult, állapot frissítése folyamatban...';
                }
                startWorkflowPolling(result.job_id);
            } catch (error) {
                console.error('Workflow indítási hiba:', error);
                if (statusText) {
                    statusText.textContent = `Hiba: ${error.message}`;
                }
                if (startButton) {
                    startButton.disabled = false;
                    startButton.classList.remove('btn-processing');
                }
                if (spinner) {
                    spinner.classList.add('d-none');
                }
                if (stopButton) {
                    stopButton.classList.add('d-none');
                    stopButton.disabled = false;
                }
                updateInfoBox('danger', `Workflow indítása sikertelen: ${error.message}`);
                updateLogStatus('A log a workflow indítása után jelenik meg.', 'muted');
            }
        }

        function startWorkflowPolling(jobId, triggerImmediate = true) {
            stopWorkflowPolling();
            currentWorkflowJobId = jobId;
            if (triggerImmediate) {
                pollWorkflowStatus();
            }
            workflowPollInterval = setInterval(pollWorkflowStatus, 5000);
        }

        function stopWorkflowPolling() {
            if (workflowPollInterval) {
                clearInterval(workflowPollInterval);
                workflowPollInterval = null;
            }
        }

        async function pollWorkflowStatus() {
            if (!currentWorkflowJobId) {
                return;
            }
            try {
                const response = await fetch(`/api/workflow-status/${currentWorkflowJobId}`);
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Nem sikerült lekérdezni az állapotot.');
                }
                const job = result.job;
                renderWorkflowStatus(job);
                if (['completed', 'failed', 'cancelled'].includes(job.status)) {
                    stopWorkflowPolling();
                    stopLogPolling();
                    currentWorkflowJobId = null;
                }
            } catch (error) {
                console.error('Állapot lekérdezési hiba:', error);
                stopWorkflowPolling();
                stopLogPolling();
                currentWorkflowJobId = null;
            }
        }

        function renderWorkflowStatus(job) {
            const badge = document.getElementById('workflowStatusBadge');
            const statusText = document.getElementById('workflowStatusText');
            const logLink = document.getElementById('workflowLogLink');
            const startButton = document.getElementById('startWorkflowBtn');
            const startSpinner = document.getElementById('workflowSpinner');
            const stopButton = document.getElementById('stopWorkflowBtn');
            const stopSpinner = document.getElementById('stopWorkflowSpinner');
            const stopLabel = document.getElementById('stopWorkflowLabel');
            const hint = document.getElementById('workflowStatusHint');

            const statusLabels = {
                queued: 'Sorban áll',
                running: 'Folyamatban',
                completed: 'Kész',
                failed: 'Hiba',
                cancelling: 'Megszakítás folyamatban',
                cancelled: 'Megszakítva'
            };

            if (!job) {
                if (badge) {
                    badge.textContent = 'Nincs aktív feladat';
                    setWorkflowBadge(null);
                }
                if (statusText) {
                    statusText.textContent = collectScriptStepsForRun(0).length ? 'Workflow még nem futott ezen a projekten.' : 'Adj hozzá lépéseket az indításhoz.';
                }
                if (logLink) {
                    logLink.innerHTML = '';
                }
                if (startButton) {
                    startButton.disabled = collectScriptStepsForRun(0).length === 0;
                    startButton.classList.remove('btn-processing');
                }
                if (startSpinner) {
                    startSpinner.classList.add('d-none');
                }
                if (stopButton) {
                    stopButton.classList.add('d-none');
                    stopButton.disabled = false;
                }
                if (hint) {
                    hint.textContent = 'Állítsd össze a futtatandó lépéseket, konfiguráld a paramétereket, majd indítsd a workflow-t.';
                }
                updateLogStatus('A log a workflow indítása után jelenik meg.');
                return;
            }

            if (badge) {
                badge.textContent = statusLabels[job.status] || job.status || 'Ismeretlen';
                setWorkflowBadge(job.status);
            }

            const activeStatuses = ['queued', 'running', 'cancelling'];
            const isActive = activeStatuses.includes(job.status);

            if (isActive) {
                if (startButton) {
                    startButton.disabled = true;
                    startButton.classList.add('btn-processing');
                }
                if (startSpinner) {
                    startSpinner.classList.remove('d-none');
                }
                if (stopButton) {
                    stopButton.classList.remove('d-none');
                    stopButton.disabled = Boolean(job.cancel_requested);
                }
                if (stopSpinner) {
                    stopSpinner.classList.toggle('d-none', Boolean(job.cancel_requested));
                }
                if (stopLabel) {
                    stopLabel.textContent = job.cancel_requested ? 'Megszakítás kérése folyamatban...' : 'Workflow megszakítása';
                }
                const activeJobId = currentWorkflowJobId || job.job_id;
                if (activeJobId) {
                    startLogPolling(activeJobId);
                }
            } else {
                if (startButton) {
                    startButton.disabled = collectScriptStepsForRun(0).length === 0;
                    startButton.classList.remove('btn-processing');
                }
                if (startSpinner) {
                    startSpinner.classList.add('d-none');
                }
                if (stopButton) {
                    stopButton.classList.add('d-none');
                    stopButton.disabled = false;
                }
                if (stopSpinner) {
                    stopSpinner.classList.add('d-none');
                }
                if (stopLabel) {
                    stopLabel.textContent = 'Workflow megszakítása';
                }
                stopLogPolling();
            }

            if (statusText) {
                const stepInfo = job.current_step && job.current_step.display_name
                    ? `${job.current_step.index}/${job.current_step.total} – ${job.current_step.display_name}`
                    : '';
                statusText.textContent = [job.message || '', stepInfo].filter(Boolean).join(' ');
            }

            if (hint) {
                if (job.status === 'queued') {
                    hint.textContent = 'Feladat sorban áll – néhány másodpercen belül indul.';
                } else if (job.status === 'running') {
                    hint.textContent = 'Folyamatban lévő workflow – a logban követheted a lépéseket.';
                } else if (job.status === 'cancelling') {
                    hint.textContent = 'Megszakítás folyamatban – várakozás a folyamat leállítására.';
                } else if (job.status === 'failed') {
                    hint.textContent = 'Hiba történt – nyisd meg a logot és ellenőrizd, melyik lépés állt le.';
                } else if (job.status === 'cancelled') {
                    hint.textContent = 'Workflow megszakítva – szükség esetén indíts új feldolgozást.';
                } else if (job.status === 'completed') {
                    hint.textContent = 'Workflow sikeresen lefutott – a fájlok a projekt könyvtárban találhatók.';
                }
            }

            if (logLink) {
                if (job.log && job.log.url) {
                    logLink.innerHTML = `<a href="${job.log.url}" target="_blank" rel="noopener">Log megnyitása</a>`;
                } else {
                    logLink.innerHTML = '';
                }
            }

            if (job.status === 'failed') {
                updateLogStatus('A workflow hibával leállt. Ellenőrizd a logot.', 'danger');
            } else if (job.status === 'cancelled') {
                updateLogStatus('A workflow megszakítva.', 'danger');
            } else if (job.status === 'completed') {
                updateLogStatus('A workflow befejeződött.', 'success');
            } else if (isActive) {
                updateLogStatus('A workflow fut – a log folyamatosan frissül.', 'info');
            }
        }

        function setWorkflowBadge(status) {
            const badge = document.getElementById('workflowStatusBadge');
            if (!badge) return;
            badge.classList.remove('bg-secondary', 'bg-primary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info');
            switch (status) {
                case 'queued':
                    badge.classList.add('bg-info');
                    break;
                case 'running':
                    badge.classList.add('bg-primary');
                    break;
                case 'completed':
                    badge.classList.add('bg-success');
                    break;
                case 'failed':
                    badge.classList.add('bg-danger');
                    break;
                case 'cancelling':
                case 'cancelled':
                    badge.classList.add('bg-warning');
                    break;
                default:
                    badge.classList.add('bg-secondary');
                    break;
            }
        }

        function updateInfoBox(level, message) {
            const infoBox = document.getElementById('workflowInfo');
            if (!infoBox) {
                return;
            }
            infoBox.classList.remove('alert-info', 'alert-secondary', 'alert-warning', 'alert-danger', 'alert-success');
            const classMap = {
                info: 'alert-info',
                success: 'alert-success',
                warning: 'alert-warning',
                danger: 'alert-danger',
                secondary: 'alert-secondary'
            };
            infoBox.classList.add(classMap[level] || 'alert-secondary');
            if (message !== undefined) {
                infoBox.textContent = message;
            }
            infoBox.classList.remove('d-none');
        }

        function updateLogStatus(text, tone = 'muted') {
            const statusEl = document.getElementById('workflowLogStatus');
            if (!statusEl) return;
            statusEl.textContent = text;
            statusEl.classList.remove('text-muted', 'text-danger', 'text-success', 'text-info');
            const toneClass = {
                muted: 'text-muted',
                danger: 'text-danger',
                success: 'text-success',
                info: 'text-info'
            }[tone] || 'text-muted';
            statusEl.classList.add(toneClass);
        }

        function startLogPolling(jobId, immediate = false) {
            stopLogPolling();
            currentLogJobId = jobId;
            if (immediate) {
                fetchWorkflowLog();
            }
            workflowLogInterval = setInterval(fetchWorkflowLog, 4000);
        }

        function stopLogPolling(silent = false) {
            if (workflowLogInterval) {
                clearInterval(workflowLogInterval);
                workflowLogInterval = null;
            }
            if (!silent) {
                currentLogJobId = null;
            }
        }

        async function fetchWorkflowLog() {
            if (!currentWorkflowJobId && !currentLogJobId) {
                return;
            }
            const jobId = currentWorkflowJobId || currentLogJobId;
            try {
                const response = await fetch(`/api/workflow-log/${jobId}`);
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Nem sikerült beolvasni a logot.');
                }
                const logContent = document.getElementById('workflowLogContent');
                if (logContent) {
                    logContent.textContent = result.log || '—';
                }
                updateLogStatus(result.completed ? 'A workflow befejeződött.' : 'A log folyamatosan frissül.', result.completed ? 'success' : 'info');
            } catch (error) {
                console.error('Log olvasási hiba:', error);
                updateLogStatus('Nem sikerült frissíteni a logot.', 'danger');
            }
        }

        async function stopWorkflow() {
            if (!currentWorkflowJobId) {
                return;
            }
            const stopButton = document.getElementById('stopWorkflowBtn');
            const stopSpinner = document.getElementById('stopWorkflowSpinner');
            const stopLabel = document.getElementById('stopWorkflowLabel');
            const statusText = document.getElementById('workflowStatusText');

            if (stopButton) {
                stopButton.disabled = true;
            }
            if (stopSpinner) {
                stopSpinner.classList.remove('d-none');
            }
            if (stopLabel) {
                stopLabel.textContent = 'Megszakítás kérve...';
            }

            try {
                const response = await fetch(`/api/stop-workflow/${currentWorkflowJobId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Ismeretlen hiba a megszakítás során.');
                }
                if (statusText) {
                    statusText.textContent = result.message || 'Megszakítás kérve. Várakozás a leállásra...';
                }
                updateLogStatus('Megszakítás kérve. Várakozás a folyamat leállítására.', 'info');
            } catch (error) {
                console.error('Workflow megszakítási hiba:', error);
                alert('Nem sikerült megszakítani a workflow-t: ' + error.message);
                if (stopButton) {
                    stopButton.disabled = false;
                }
                if (stopSpinner) {
                    stopSpinner.classList.add('d-none');
                }
                if (stopLabel) {
                    stopLabel.textContent = 'Workflow megszakítása';
                }
            }
        }


        function showTranscribeModal(projectName, fileName) {
            document.getElementById('transcribeProjectName').value = projectName;
            document.getElementById('transcribeFileName').value = fileName;
            const modal = new bootstrap.Modal(document.getElementById('transcribeModal'));
            modal.show();
        }

        function runTranscription() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('transcribeModal'));
            modal.hide();

            const payload = {
                auto_chunk: document.getElementById('autoChunk').checked,
                chunk_seconds: document.getElementById('chunkSeconds').value,
                max_pause: document.getElementById('maxPause').value,
                timestamp_padding: document.getElementById('timestampPadding').value,
                max_segment_duration: document.getElementById('maxSegmentDuration').value,
                diarization: document.getElementById('enableDiarization').checked,
                language: document.getElementById('transcribeLanguage').value,
                temperature: document.getElementById('temperature').value,
                beam_size: document.getElementById('beamSize').value,
                device: document.getElementById('transcribeDevice').value
            };

            const projectName = document.getElementById('transcribeProjectName').value;
            const buttonId = 'transcribeBtn';
            setButtonLoading(buttonId, true);

            fetch(`/api/transcribe/${projectName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Sikeres beolvasás!');
                    location.reload();
                } else {
                    alert('Hiba: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Hiba:', error);
                alert('Hiba történt a beolvasás során');
            })
            .finally(() => {
                setButtonLoading(buttonId, false);
            });
        }

        function setButtonLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (btn) {
                if (isLoading) {
                    btn.classList.add('btn-loading');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('btn-loading');
                    btn.disabled = false;
                    btn.classList.remove('btn-processing');
                }
            }
        }

        function runAudioExtraction(projectName, button) {
            if (!button.classList.contains('btn-processing')) {
                button.classList.add('btn-processing');
            }

            const keepChannelsToggle = document.getElementById('extractKeepChannels');
            const keepChannels = keepChannelsToggle ? keepChannelsToggle.checked : false;

            fetch(`/api/extract-audio/${projectName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keep_channels: keepChannels
                })
            })
            .then(response => response.json())
            .then(data => {
                button.classList.remove('btn-processing');
                if (data.success) {
                    alert('Sikeres audio kivonás!');
                    location.reload();
                } else {
                    alert('Hiba: ' + data.error);
                }
            })
            .catch(error => {
                button.classList.remove('btn-processing');
                console.error('Hiba:', error);
                alert('Hiba történt az audio kivonás során');
            });
        }

        function handleTranscribeClick(projectName, button) {
            if (!button.classList.contains('btn-processing')) {
                button.classList.add('btn-processing');
            }

            const audioElements = document.querySelectorAll('#speechAudioList audio source');
            if (audioElements.length > 0) {
                const fileName = audioElements[0].src.split('/').pop();
                showTranscribeModal(projectName, fileName);
            } else {
                button.classList.remove('btn-processing');
                alert('Nincs audió fájl a listában!');
            }
        }

        function showSeparateModal(projectName, fileName, button) {
            document.getElementById('separateProjectName').value = projectName;
            const modalElement = document.getElementById('separateModal');
            const modal = new bootstrap.Modal(modalElement);

            modal.show();

            modalElement.addEventListener('hidden.bs.modal', function () {
                if (button) {
                    button.classList.remove('btn-processing');
                }
            }, { once: true });
        }

        function runSeparation() {
            const projectName = document.getElementById('separateProjectName').value;
            const device = document.getElementById('separateDevice').value;
            const keepFullAudio = document.getElementById('keepFullAudio').checked;
            const nonSpeechSilence = document.getElementById('nonSpeechSilence').checked;
            const chunkSize = document.getElementById('chunkSize').value;
            const model = document.getElementById('separateModel').value;

            const modal = bootstrap.Modal.getInstance(document.getElementById('separateModal'));
            modal.hide();

            fetch(`/api/separate-audio/${projectName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device: device,
                    keep_full_audio: keepFullAudio,
                    non_speech_silence: nonSpeechSilence,
                    chunk_size: chunkSize,
                    model: model
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Sikeres szétválasztás!');
                    location.reload();
                } else {
                    alert('Hiba: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Hiba:', error);
                alert('Hiba történt a szétválasztás során');
            });
        }

        function runAudioSeparation(projectName, fileName, button) {
            showSeparateModal(projectName, fileName, button || document.getElementById('separateBtn'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            initWorkflowModals();
            initWorkflowButtons();
            initWorkflowKeyModal();
            const refreshLogBtn = document.getElementById('refreshWorkflowLogBtn');
            if (refreshLogBtn) {
                refreshLogBtn.addEventListener('click', () => fetchWorkflowLog());
            }
            loadWorkflowOptions(PROJECT_NAME);
        });
    </script>
</head>
<body>
    {% macro render_file_tree(entries) -%}
        <ul class="file-browser-tree list-unstyled mb-0">
            {%- for entry in entries %}
                <li>
                    {%- if entry.type == 'directory' %}
                        <details class="file-browser-directory" open>
                            <summary class="file-browser-summary">
                                <span class="file-browser-icon">[D]</span>
                                <span>{{ entry.name }}</span>
                            </summary>
                            {{ render_file_tree(entry.children) }}
                        </details>
                    {%- else %}
                        <div class="file-browser-item">
                            <span class="file-browser-icon">[F]</span>
                            <a href="{{ url_for('serve_workdir', filename=project.name + '/' + entry.path) }}" target="_blank" rel="noopener">
                                {{ entry.name }}
                            </a>
                        </div>
                    {%- endif %}
                </li>
            {%- endfor %}
        </ul>
    {%- endmacro %}
    <button class="theme-toggle" onclick="toggleTheme()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>

    <div class="container mt-4">
        <h1 class="mb-4">Projekt: {{ project.name }}</h1>

        <div class="card mb-4">
            <div class="card-header d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h5 class="mb-0">Moduláris AI workflow</h5>
                    <span id="workflowStatusBadge" class="badge bg-secondary">Nincs aktív feladat</span>
                </div>
                <small id="workflowStatusHint" class="text-muted">Állítsd össze a futtatandó lépéseket, konfiguráld a paramétereket, majd indítsd a workflow-t.</small>
            </div>
            <div class="card-body">
                <div class="alert alert-info small mb-3" role="alert" id="workflowInfo">
                    Válaszd ki a scripts mappában elérhető lépéseket, állítsd be a paramétereket egyenként, majd indítsd el a kívánt munkafolyamatot. A projektnév automatikusan kitöltésre kerül minden lépésnél.
                </div>
                <div class="d-flex flex-column gap-2 mb-3">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <label for="workflowTemplateSelect" class="form-label mb-0">Mentett workflow</label>
                        <select class="form-select form-select-sm" id="workflowTemplateSelect" style="min-width: 220px;"></select>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="loadWorkflowTemplateBtn">Betöltés</button>
                        <button type="button" class="btn btn-outline-success btn-sm" id="saveWorkflowBtn">Mentés sablonként</button>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <div class="d-flex flex-wrap gap-2">
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" id="addWorkflowStepBtn">Lépés hozzáadása</button>
                                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    Widget hozzáadása
                                </button>
                                <ul class="dropdown-menu" id="workflowWidgetMenu">
                                    <li><h6 class="dropdown-header">Speciális widgetek</h6></li>
                                    <li>
                                        <button class="dropdown-item" type="button" data-widget-id="reviewContinue">
                                            Review + Continue widget
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <button type="button" class="btn btn-outline-secondary" id="resetWorkflowBtn">Alapértelmezett lépések</button>
                        </div>
                        <span class="badge bg-warning text-dark d-none" id="workflowMissingBadge">Hiányzó paraméterek</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="workflowStepsTable">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 70px;">Aktív</th>
                                <th scope="col">Lépés</th>
                                <th scope="col" style="width: 140px;">Környezet</th>
                                <th scope="col" style="width: 150px;">Hiba esetén</th>
                                <th scope="col" style="width: 220px;">Műveletek</th>
                            </tr>
                        </thead>
                        <tbody id="workflowStepsBody">
                            <tr class="text-muted">
                                <td colspan="5">Még nem adtál hozzá lépéseket.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
                    <button type="button" class="btn btn-success d-flex align-items-center gap-2" id="startWorkflowBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="workflowSpinner"></span>
                        <span>Workflow indítása</span>
                    </button>
                    <button type="button" class="btn btn-outline-danger d-flex align-items-center gap-2 d-none" id="stopWorkflowBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="stopWorkflowSpinner"></span>
                        <span id="stopWorkflowLabel">Workflow megszakítása</span>
                    </button>
                    <span id="workflowStatusText" class="text-muted small flex-grow-1">Állapot frissítése folyamatban...</span>
                </div>
                <div class="log-panel mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Workflow log</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshWorkflowLogBtn">Frissítés</button>
                    </div>
                    <div id="workflowLogStatus" class="small text-muted mb-2">
                        A log a workflow indítása után jelenik meg.
                    </div>
                    <div id="workflowLogLink" class="small mb-2"></div>
                    <pre id="workflowLogContent" class="log-viewer">—</pre>
                </div>
                <div id="workflowTips" class="small text-muted mt-3">
                    Tipp: a lépések paraméterei egyenként módosíthatók. A logban minden végrehajtott parancs kimenete megjelenik.
                </div>
            </div>
        </div>

        <!-- Workflow Step Picker Modal -->
        <div class="modal fade" id="workflowStepModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Új workflow lépés hozzáadása</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="search" class="form-control" id="workflowStepSearch" placeholder="Szűrés név alapján...">
                        </div>
                        <div class="list-group" id="workflowStepList">
                            <div class="list-group-item text-muted">Betöltés folyamatban...</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bezárás</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow Parameters Modal -->
        <div class="modal fade" id="workflowParamsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="workflowParamsTitle">Paraméterek szerkesztése</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="workflowParamsAlert" class="alert alert-warning small d-none"></div>
                        <form id="workflowParamsForm">
                            <div id="workflowParamsContainer" class="vstack gap-3"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                        <button type="button" class="btn btn-primary" id="workflowParamsSaveBtn">Mentés</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2">
                <h5 class="mb-0">Projekt fájlok</h5>
                <small class="text-muted">A lista a workdir/{{ project.name }} könyvtár aktuális tartalmát mutatja.</small>
            </div>
            <div class="card-body">
                {% if project_tree %}
                    <div class="file-browser">
                        {{ render_file_tree(project_tree) }}
                    </div>
                {% else %}
                    <p class="mb-0">A projekt mappa üres.</p>
                {% endif %}
            </div>
        </div>

        <a href="/" class="btn btn-secondary">Vissza a főoldalra</a>
    </div>

    <!-- Separate Audio Modal -->
    <div class="modal fade" id="separateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Szétválasztás paraméterei</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="separateForm">
                        <input type="hidden" id="separateProjectName">
                        <div class="mb-3">
                            <label for="separateDevice" class="form-label">Eszköz</label>
                            <select class="form-select" id="separateDevice">
                                <option value="cuda">CUDA (GPU)</option>
                                <option value="cpu">CPU</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="keepFullAudio">
                            <label class="form-check-label" for="keepFullAudio">Teljes audio fájl megtartása</label>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="nonSpeechSilence">
                            <label class="form-check-label" for="nonSpeechSilence">Csak csend a non_speech fájlban</label>
                        </div>
                        <div class="mb-3">
                            <label for="chunkSize" class="form-label">Darabolás hossza (perc)</label>
                            <input type="number" class="form-control" id="chunkSize" value="5" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="separateModel" class="form-label">Modell</label>
                            <select class="form-select" id="separateModel">
                                <option value="htdemucs_ft" selected>htdemucs_ft</option>
                                <option value="htdemucs">htdemucs</option>
                                <option value="hdemucs_mmi">hdemucs_mmi</option>
                                <option value="mdx">mdx</option>
                                <option value="mdx_extra">mdx_extra</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button type="button" class="btn btn-primary" onclick="runSeparation()">Futtatás</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transcribe Modal -->
    <div class="modal fade" id="transcribeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Beolvasás paraméterei</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="transcribeForm">
                        <input type="hidden" id="transcribeProjectName">
                        <input type="hidden" id="transcribeFileName">
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="autoChunk" checked>
                            <label class="form-check-label" for="autoChunk">Automatikus chunk-méret kalibráció</label>
                        </div>
                        <div class="mb-3">
                            <label for="chunkSeconds" class="form-label">Fix chunk-méret (másodperc)</label>
                            <input type="number" class="form-control" id="chunkSeconds" value="30" min="1">
                            <small class="text-muted">Csak akkor kerül felhasználásra, ha az automatikus kalibráció ki van kapcsolva.</small>
                        </div>
                        <div class="mb-3">
                            <label for="maxPause" class="form-label">Maximális szünet a mondatok között (másodperc)</label>
                            <input type="number" class="form-control" id="maxPause" value="0.6" min="0" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label for="timestampPadding" class="form-label">Időbélyeg kiterjesztés (másodperc)</label>
                            <input type="number" class="form-control" id="timestampPadding" value="0.2" min="0" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label for="maxSegmentDuration" class="form-label">Mondatszegmens maximális hossza (másodperc)</label>
                            <input type="number" class="form-control" id="maxSegmentDuration" value="11.5" min="0" step="0.5">
                            <small class="text-muted">Állítsd 0-ra, ha nem szeretnéd korlátozni a szegmens hosszát.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button type="button" class="btn btn-primary" onclick="runTranscription()">Futtatás</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Workflow Save Modal -->
        <div class="modal fade" id="workflowSaveModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Workflow sablon mentése</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>
                    <div class="modal-body">
                        <div id="workflowSaveError" class="alert alert-danger small d-none"></div>
                        <div class="mb-3">
                            <label for="workflowSaveName" class="form-label">Sablon neve</label>
                            <input type="text" class="form-control" id="workflowSaveName" placeholder="Pl. Alap beállítások">
                        </div>
                        <div class="mb-3">
                            <label for="workflowSaveDescription" class="form-label">Leírás (opcionális)</label>
                            <textarea class="form-control" id="workflowSaveDescription" rows="2" placeholder="Rövid megjegyzés a sablonhoz"></textarea>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="workflowSaveOverwrite">
                            <label class="form-check-label" for="workflowSaveOverwrite">Aktuális sablon felülírása</label>
                        </div>
                        <div class="small text-muted d-none" id="workflowSaveOverwriteInfo"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                        <button type="button" class="btn btn-primary" id="workflowSaveConfirmBtn">Mentés</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow API Keys Modal -->
        <div class="modal fade" id="workflowKeysModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">API kulcsok megadása</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning small" id="workflowKeysInfo">
                        A workflow indításához add meg a hiányzó API kulcsokat.
                    </div>
                    <div class="mb-3 d-none" id="workflowKeyFieldChatgpt">
                        <label for="workflowKeyChatgpt" class="form-label">OpenAI / ChatGPT API kulcs</label>
                        <input type="password" class="form-control" id="workflowKeyChatgpt" placeholder="sk-..." autocomplete="off">
                    </div>
                    <div class="mb-3 d-none" id="workflowKeyFieldDeepl">
                        <label for="workflowKeyDeepl" class="form-label">DeepL API kulcs</label>
                        <input type="password" class="form-control" id="workflowKeyDeepl" placeholder="DeepL API kulcs" autocomplete="off">
                    </div>
                    <div class="mb-3 d-none" id="workflowKeyFieldHuggingface">
                        <label for="workflowKeyHuggingface" class="form-label">Hugging Face token</label>
                        <input type="password" class="form-control" id="workflowKeyHuggingface" placeholder="hf_..." autocomplete="off">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button type="button" class="btn btn-primary d-flex align-items-center gap-2" id="workflowKeysSubmitBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="workflowKeysSpinner" role="status" aria-hidden="true"></span>
                        <span id="workflowKeysSubmitLabel">Mentés és indítás</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
